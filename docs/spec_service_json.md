# ğŸ“ æœåŠ¡åŒ…è§„èŒƒè¯´æ˜ä¹¦ (Service Manifest Specification)

åœ¨ GDOS ç³»ç»Ÿä¸­ï¼Œæ‰€æœ‰ä¸Šä¼ è‡³ Master çš„æœåŠ¡åŒ…ï¼ˆ`.zip`ï¼‰å¿…é¡»åœ¨**æ ¹ç›®å½•**ä¸‹åŒ…å«ä¸€ä¸ªåä¸º `service.json` çš„å…ƒæ•°æ®æ–‡ä»¶ã€‚Worker èŠ‚ç‚¹å°†ä¸¥æ ¼ä¾æ®æ­¤æ–‡ä»¶æ¥æ‰§è¡Œéƒ¨ç½²ã€å¯åŠ¨ã€åœæ­¢ã€ç›‘æ§åŠå¥åº·æ£€æŸ¥ã€‚

æœ¬æ–‡æ¡£è¯¦ç»†å®šä¹‰äº†è¯¥æ–‡ä»¶çš„å­—æ®µè§„èŒƒåŠæœ€ä½³å®è·µã€‚

---

## 1. æ–‡ä»¶ç»“æ„è¦æ±‚

ZIP åŒ…å†…éƒ¨ç»“æ„å¿…é¡»æ˜¯æ‰å¹³çš„ï¼Œ**ä¸èƒ½**åœ¨æ ¹ç›®å½•ä¸‹å¤šå¥—ä¸€å±‚æ–‡ä»¶å¤¹ã€‚

**âœ… æ­£ç¡®ç»“æ„ï¼š**
```text
my-app.zip
â”œâ”€â”€ service.json
â”œâ”€â”€ bin/
â”‚   â””â”€â”€ app
â””â”€â”€ conf/
    â””â”€â”€ config.yaml
```

**âŒ é”™è¯¯ç»“æ„ï¼š**
```text
my-app.zip
â””â”€â”€ my-app-v1.0/      <-- å¤šäº†ä¸€å±‚ç›®å½•ï¼Œä¼šå¯¼è‡´ Worker æ‰¾ä¸åˆ° service.json
    â”œâ”€â”€ service.json
    â””â”€â”€ ...
```

---

## 2. å­—æ®µè¯¦è§£ (Schema Reference)

### 2.1 åŸºç¡€ä¿¡æ¯ (Basic Info)

| å­—æ®µå | ç±»å‹ | å¿…å¡« | æè¿° |
| :--- | :--- | :--- | :--- |
| `name` | string | **æ˜¯** | æœåŠ¡åç§°ï¼Œå…¨å±€å”¯ä¸€æ ‡è¯†ï¼ˆå»ºè®®ä»…ä½¿ç”¨è‹±æ–‡å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ï¼‰ã€‚ |
| `version` | string | **æ˜¯** | ç‰ˆæœ¬å·ï¼ˆå¦‚ `1.0.0`, `v2.1-beta`ï¼‰ã€‚ |
| `description` | string | å¦ | æœåŠ¡çš„ç®€è¦æè¿°ï¼Œæ˜¾ç¤ºåœ¨ Web ç•Œé¢ä¸Šã€‚ |
| `os` | string | å¦ | é€‚ç”¨æ“ä½œç³»ç»Ÿã€‚æšä¸¾å€¼ï¼š`linux`, `windows`, `darwin`ã€‚é»˜è®¤ä¸ºç©ºï¼ˆé€šç”¨ï¼‰ã€‚ |

### 2.2 å¯åŠ¨ä¸è¿è¡Œ (Runtime)

| å­—æ®µå | ç±»å‹ | å¿…å¡« | æè¿° |
| :--- | :--- | :--- | :--- |
| `entrypoint` | string | **æ˜¯** | å¯åŠ¨å‘½ä»¤çš„å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„ï¼ˆç›¸å¯¹äº ZIP åŒ…æ ¹ç›®å½•ï¼‰ã€‚<br>Worker ä¼šè‡ªåŠ¨å¤„ç† Linux æƒé™ (`+x`) å’Œ Windows åç¼€è¡¥å…¨ (`.exe`)ã€‚ |
| `args` | []string | å¦ | å¯åŠ¨å‚æ•°æ•°ç»„ã€‚ä¾‹å¦‚ `["-c", "conf.yaml"]`ã€‚ |
| `env` | map[string]string | å¦ | æ³¨å…¥åˆ°è¿›ç¨‹çš„ç¯å¢ƒå˜é‡é”®å€¼å¯¹ã€‚ |

### 2.3 åœæ­¢ç­–ç•¥ (Stop Policy)

| å­—æ®µå | ç±»å‹ | å¿…å¡« | æè¿° |
| :--- | :--- | :--- | :--- |
| `stop_entrypoint` | string | å¦ | è‡ªå®šä¹‰åœæ­¢è„šæœ¬è·¯å¾„ã€‚å¦‚æœä¸å¡«ï¼Œé»˜è®¤é‡‡ç”¨ `Kill PID` æ–¹å¼ã€‚ |
| `stop_args` | []string | å¦ | åœæ­¢è„šæœ¬çš„å‚æ•°ã€‚ |

> **æ³¨æ„**ï¼šå¯¹äº Java (Spring Boot) æˆ– Tomcat ç­‰å¤æ‚åº”ç”¨ï¼Œå»ºè®®æä¾› `stop.sh` ä»¥å®ç°ä¼˜é›…åœæœºï¼ˆGraceful Shutdownï¼‰ã€‚

### 2.4 å°±ç»ªæ£€æµ‹ (Readiness Probe)

ç”¨äºåˆ¤æ–­æœåŠ¡æ˜¯å¦çœŸæ­£å¯åŠ¨æˆåŠŸï¼Œè€Œä¸ä»…ä»…æ˜¯è¿›ç¨‹å­˜åœ¨ã€‚

| å­—æ®µå | ç±»å‹ | é»˜è®¤å€¼ | æè¿° |
| :--- | :--- | :--- | :--- |
| `readiness_type` | string | `none` | æ£€æµ‹ç±»å‹ï¼š<br>`tcp`: æ£€æŸ¥ç«¯å£è¿é€šæ€§<br>`http`: æ£€æŸ¥æ¥å£è¿”å› 200-399<br>`time`: å¼ºåˆ¶ç­‰å¾…å›ºå®šæ—¶é—´<br>`none`: ä¸æ£€æµ‹ï¼Œè¿›ç¨‹å¯åŠ¨å³è§†ä¸ºæˆåŠŸ |
| `readiness_target` | string | - | æ£€æµ‹ç›®æ ‡ï¼š<br>TCP: `127.0.0.1:8080`<br>HTTP: `http://127.0.0.1:8080/health`<br>Time: `30` (ç§’) |
| `readiness_timeout` | int | `30` | æ£€æµ‹è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ã€‚è¶…æ—¶åæ ‡è®°ä¸ºå¯åŠ¨å¤±è´¥ã€‚ |

### 2.5 å¯è§‚æµ‹æ€§ (Observability)

| å­—æ®µå | ç±»å‹ | æè¿° |
| :--- | :--- | :--- |
| `log_paths` | map[string]string | æ—¥å¿—æ–‡ä»¶æ˜ å°„è¡¨ã€‚ç”¨äº Web ç»ˆç«¯æŸ¥çœ‹æ—¥å¿—ã€‚<br>**Key**: æ˜¾ç¤ºåç§° (å¦‚ "Access Log")<br>**Value**: ç›¸å¯¹è·¯å¾„ (å¦‚ "logs/access.log") |

---

## 3. é…ç½®ç¤ºä¾‹

### åœºæ™¯ Aï¼šæ ‡å‡†çš„ Linux åç«¯æœåŠ¡ (Go/Python/Node)

è¿™æ˜¯ä¸€ä¸ªæœ€å…¸å‹çš„é…ç½®ï¼ŒåŒ…å«ç¯å¢ƒå˜é‡æ³¨å…¥å’Œ HTTP å¥åº·æ£€æŸ¥ã€‚

```json
{
  "name": "payment-api",
  "version": "1.2.0",
  "description": "æ”¯ä»˜ç½‘å…³æ ¸å¿ƒæœåŠ¡",
  "os": "linux",
  
  "entrypoint": "bin/server",
  "args": ["--config", "conf/prod.yaml"],
  
  "env": {
    "GIN_MODE": "release",
    "REDIS_HOST": "192.168.1.50"
  },

  "readiness_type": "http",
  "readiness_target": "http://127.0.0.1:8080/healthz",
  "readiness_timeout": 15,

  "log_paths": {
    "App Log": "logs/app.log",
    "Error Log": "logs/error.log"
  }
}
```

### åœºæ™¯ Bï¼šWindows é—ç•™ç¨‹åº

æ¼”ç¤ºå¦‚ä½•é…ç½® Windows ä¸‹çš„ç¨‹åºï¼Œä»¥åŠè‡ªå®šä¹‰åœæ­¢è„šæœ¬ã€‚

```json
{
  "name": "legacy-data-processor",
  "version": "2.0.0",
  "os": "windows",
  
  "entrypoint": "LegacyApp.exe", 
  "args": [],
  
  // Windows ä¸‹å¸¸é©»è¿›ç¨‹å¯èƒ½æ— æ³•ç›´æ¥ Killï¼Œè°ƒç”¨è„šæœ¬åœæ­¢
  "stop_entrypoint": "scripts/stop.bat",
  
  "readiness_type": "tcp",
  "readiness_target": "127.0.0.1:9090",

  "log_paths": {
    "Trace": "logs/trace.log"
  }
}
```

### åœºæ™¯ Cï¼šJava åº”ç”¨ (Spring Boot)

Java åº”ç”¨é€šå¸¸éœ€è¦è¾ƒé•¿çš„å¯åŠ¨æ—¶é—´ï¼Œä¸”æœ€å¥½é€šè¿‡è„šæœ¬å¯åŠ¨ä»¥è®¾ç½® JVM å‚æ•°ã€‚

```json
{
  "name": "order-center",
  "version": "1.0.0-SNAPSHOT",
  
  // å»ºè®®å°è£…ä¸€ä¸ª shell è„šæœ¬æ¥å¯åŠ¨ java -jar ...
  "entrypoint": "bin/startup.sh",
  
  // ç•™è¶³å¯åŠ¨æ—¶é—´
  "readiness_type": "http",
  "readiness_target": "http://127.0.0.1:8080/actuator/health",
  "readiness_timeout": 60,

  "log_paths": {
    "Spring Log": "logs/spring.log"
  }
}
```

---

## 4. æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹

1.  **è·¯å¾„åˆ†éš”ç¬¦**ï¼šJSON ä¸­æ‰€æœ‰è·¯å¾„å»ºè®®ç»Ÿä¸€ä½¿ç”¨æ­£æ–œæ  `/`ã€‚Worker ä¼šåœ¨ Windows ä¸‹è‡ªåŠ¨è½¬æ¢ä¸ºåæ–œæ  `\`ã€‚
2.  **é¿å…ç»å¯¹è·¯å¾„**ï¼š`entrypoint` å’Œ `log_paths` è¯·åŠ¡å¿…ä½¿ç”¨**ç›¸å¯¹è·¯å¾„**ï¼ˆç›¸å¯¹äº ZIP åŒ…æ ¹ç›®å½•ï¼‰ã€‚
3.  **æƒé™å¤„ç†**ï¼šåœ¨ Linux ä¸‹ï¼ŒWorker åœ¨è§£å‹ ZIP æ—¶ä¼šè‡ªåŠ¨å°è¯•èµ‹äºˆ `entrypoint` æŒ‡å®šçš„æ–‡ä»¶ `+x` (0755) æƒé™ï¼Œå› æ­¤ä½ ä¸éœ€è¦åœ¨æ‰“åŒ…å‰æ‰‹åŠ¨ `chmod`ã€‚
4.  **å‰å°è¿è¡Œ**ï¼š
    *   **éå¸¸é‡è¦**ï¼šä½ çš„ç¨‹åºå¿…é¡»æ˜¯**å‰å°è¿è¡Œ (Foreground)** çš„ï¼Œä¸èƒ½åœ¨å†…éƒ¨ `fork` åé€€å‡ºï¼ˆDaemonizeï¼‰ã€‚
    *   å¦‚æœä¸»è¿›ç¨‹é€€å‡ºï¼ŒWorker ä¼šè®¤ä¸ºæœåŠ¡å·²åœæ­¢ã€‚
    *   ä¾‹å¦‚ Nginxï¼Œè¯·ç¡®ä¿é…ç½® `daemon off;`ã€‚
5.  **æ—¥å¿—è¾“å‡º**ï¼š
    *   æ¨èå°†æ—¥å¿—ç›´æ¥è¾“å‡ºåˆ° **Stdout/Stderr**ã€‚Worker ä¼šè‡ªåŠ¨æ•è·å¹¶å­˜å…¥ `app.log`ï¼Œè¿™æ˜¯ Web ç»ˆç«¯é»˜è®¤å±•ç¤ºçš„æ—¥å¿—ã€‚
    *   å¦‚æœå¿…é¡»å†™æ–‡ä»¶ï¼Œè¯·åœ¨ `log_paths` ä¸­é…ç½®ï¼Œä»¥ä¾¿åœ¨ Web ç«¯æŸ¥çœ‹ã€‚